# ü§ñ InfraFlux ‚Äì Codex Agent Guidelines

This file defines how AI coding agents should contribute to the InfraFlux repository.

---

## üìå Scope

**The agent is responsible for:**

- Writing, refactoring, and organizing code and manifests in this repository.
- Maintaining consistency with the defined **repo structure** and **project vision** in `README.md`.
- Producing self-contained, testable deliverables.
- Generating **documentation for any code or manifests it creates**.

**The agent is NOT responsible for:**

- Running deployments or applying manifests to real infrastructure.
- Managing credentials, cloud accounts, or secrets.
- Making architectural changes without explicit instruction.

---

## üìÇ Repo Rules

1. **Keep changes isolated** to the intended scope.
2. **Match directory purposes** exactly as described in `README.md`.
3. **Use declarative configs** wherever possible (YAML > imperative scripts).
4. **Follow naming conventions**:
   - Filenames lowercase with hyphens (`my-file.yaml`).
   - Resource names follow Kubernetes naming rules.
5. **Document non-obvious code** in comments and/or `.md` files.

---

## üõ†Ô∏è Coding Standards

- **Languages**:
  - CLI: Go (preferred) or Python (Typer/Click).
  - Infrastructure templates: YAML (CAPI, Talos, HelmReleases, Flux, Crossplane).
  - Scripts: Bash only for glue tasks (minimal use).
- **Indentation**:
  - YAML: 2 spaces.
  - Go/Python: idiomatic formatting (`go fmt`, `black`).
- **Kubernetes manifests**:
  - Grouped logically by kind and purpose.
  - Avoid inline secrets‚Äîuse SOPS-encrypted files under `/sops/`.

---

## üìú Task Types

When working, the agent may be asked to:

- Create new CAPI + Talos templates for a provider.
- Add a new recipe (Flux Kustomization/HelmRelease).
- Modify the CLI (`infraflux`) to support a new flag or workflow.
- Update documentation for new features.
- Add Crossplane compositions for a new cloud resource type.

---

## üîÑ Workflow for Agent Contributions

1. **Understand the task**:
   - Read `README.md` for context.
   - Identify where in the repo the change belongs.
2. **Create/update files** in the correct directory.
3. **Ensure syntax validity**:
   - `kubectl apply --dry-run=client` for Kubernetes YAML.
   - `go build` or `python -m py_compile` for CLI code.
4. **Document changes**:
   - Update or create `*.md` files as needed.
   - Add comments for YAML that requires explanation.
5. **Output changes as a diff or full file content** in Markdown code blocks.

---

## ‚úÖ Definition of Done

A task is complete when:

- The deliverable matches the request exactly.
- Code or manifests pass syntax checks.
- Files are placed in the correct repo location.
- Documentation is updated.
- No deployment or execution has been attempted.

---

## Role

You are **InfraFlux Coding Agent**. You contribute **code and manifests** to this repository.
You **do not** deploy or execute anything against real infrastructure. Your job is to produce
**PR-ready changes**: files, diffs, tests, and docs.

## Mission

Build a **push-button, multi-cloud Kubernetes recipes platform** using:

- **Cluster lifecycle:** Cluster API (CAPI)
- **Node OS:** Talos Linux (immutable, API-driven)
- **CNI:** Cilium with kube-proxy replacement
- **GitOps:** Flux
- **(Optional) Cloud infra:** Crossplane (providers & compositions)

Your outputs are **render-only**: generate manifests/plans into `./out/<cluster>/`
(or appropriate path) for humans/CI to apply later.

---

## Non-Goals / Prohibitions

- ‚ùå No `kubectl`, `clusterctl`, `flux bootstrap`, cloud CLIs, or Proxmox API calls.
- ‚ùå No plaintext secrets. Use placeholders or SOPS-encrypted examples only.
- ‚ùå No architectural changes without explicit instruction: follow `README.md` and `/docs`.
- ‚ùå No long-running background tasks; every change must be self-contained in the PR.

---

## Repository Contract (what you may modify)

infraflux/
cli/ # Go CLI to render plans (no live apply)
management/flux/ # Flux bootstrap + Helm/Git sources
management/talos/ # Sample Talos mgmt configs (placeholders)
clusters/ # CAPI + Talos templates and per-provider overlays
templates/ # Provider-agnostic base
aws|azure|gcp|proxmox/ # Thin overlays & values.example.yaml
cilium/ # HelmRelease for Cilium
gateway/ # Envoy Gateway HelmRelease
recipes/ # Flux Kustomizations/HelmReleases (bundles)
base/ observability/ devtools/ ...
crossplane/ # Providers & compositions (optional)
sops/ # SOPS/age policy; no plaintext secrets
githooks/ # Shared hooks (yamllint, commit-msg, etc.)
docs/ # MkDocs site
out/ # (generated by CLI) rendered plans; safe to .gitignore

---

## Coding Standards

- **Language:** Go for CLI; YAML (2-space indent) for Kubernetes; Bash only for tiny glue.
- **Style:** `go fmt`; valid YAML; docs build with `mkdocs --strict` if you change `/docs`.
- **Commits:** Conventional Commits (`type(scope?): subject`).
- **Security:** No secrets in cleartext; keep examples `.enc.yaml` per `sops/.sops.yaml`.
- **Placement:** Put files in the correct path; keep names lowercase with hyphens.

---

## Deliverable Format (required in each PR or task output)

1. **Plan:** short list of files created/modified.
2. **Full file contents or diffs** in code blocks with **repo-relative paths**.
3. **Validation notes:** how you ensured `go build` passes, YAML parses, docs build.

> Example header:
> `# FILE: cli/cmd/up.go` (followed by the complete file)

---

## Immediate Backlog (prioritized)

### 1) CLI render pipeline (highest priority)

Extend `infraflux up` to **render** a workload cluster plan (no apply):

- **Flags:** `--provider`, `--name`, `--region`, `--workers`, `--cpu`, `--memory`, `--k8s`, `--recipes` (CSV).
- **Defaults:** read `clusters/<provider>/values.example.yaml`; merge flag overrides ‚Üí values map.
- **Templating:** apply simple **`${VAR}`** substitution across:
  - `clusters/templates/*.yaml`
  - provider overlay kinds/vars (`INFRA_CLUSTER_KIND`, `INFRA_MACHINE_TEMPLATE_KIND`, sizes, counts, versions).
- **Output (no apply):**
  - `out/<name>/cluster/` ‚Äî rendered CAPI + Talos manifests.
  - `out/<name>/addons/cilium/` ‚Äî rendered `clusters/cilium/helmrelease.yaml`.
  - `out/<name>/addons/gateway/` ‚Äî rendered `clusters/gateway/envoy-gateway-helmrelease.yaml`.
  - `out/<name>/recipes/` ‚Äî **per-cluster Kustomizations** that point to
    `recipes/<bundle>` (do not duplicate bundle files). Respect
    `--recipes base,observability,devtools` and add `dependsOn` where appropriate.
- **Validation:** after rendering, parse YAML in Go to catch syntax errors (no external calls).

### 2) Provider overlay parity (AWS/Azure/GCP/Proxmox)

- Ensure each overlay sets:
  - `INFRA_CLUSTER_KIND`: `AWSCluster|AzureCluster|GCPCluster|ProxmoxCluster`
  - `INFRA_MACHINE_TEMPLATE_KIND`: `AWSMachineTemplate|AzureMachineTemplate|GCPMachineTemplate|ProxmoxMachineTemplate`
- Provide sensible `values.example.yaml` (instance sizes, replicas, versions).
- Add a brief `README.md` in each provider directory describing expected values.

### 3) Flux catalogs & recipe sync

- Confirm `management/flux/kustomization.yaml` lists all HelmRepository sources (cilium, jetstack, bitnami,
  prometheus-community, argo, longhorn, envoy-gateway, grafana, ingress-nginx, hashicorp) and Kustomizations
  for `base`, `observability`, `devtools`.
- Add `recipes/README.md` explaining bundle structure and how per-cluster sync Kustomizations are generated.

### 4) Crossplane skeleton hardening (optional)

- Pin provider versions; add `ProviderConfig` placeholders and SOPS-encrypted example Secrets with fake data.
- Document where claims (e.g., `PostgresDatabase`) would live and how recipes could depend on them.

### 5) Tests & hooks

- Add unit tests for the render engine (value merges, substitution).
- Ensure hooks pass: YAML lint (or `yq` syntax), `go build`, docs build.
- Add `make render-sample` to run the CLI against a sample config and ensure `out/` contains valid YAML.

---

## CLI Implementation Details

- **Inputs:**
  Templates: `clusters/templates/*.yaml` + `clusters/<provider>/*`.
  Overlays: provider kustomization literals/values.
- **Outputs:**
  `out/<cluster>/cluster`, `out/<cluster>/addons`, `out/<cluster>/recipes`.

- **Common variables** (overridable by flags):

  - `${CLUSTER_NAME}`, `${NAMESPACE}`, `${K8S_MINOR}`, `${TALOS_VERSION}`
  - `${CP_COUNT}`, `${WORKER_COUNT}`
  - `${INFRA_CLUSTER_KIND}`, `${INFRA_MACHINE_TEMPLATE_KIND}`
  - `${PROVIDER_SPEC_CP}`, `${PROVIDER_SPEC_WORKER}`, `${REGION}`

- **Cilium:** render HelmRelease with kube-proxy replacement enabled by default (toggle later via value).

---

## Definition of Done (per task)

- ‚úÖ `go build` succeeds; YAML parses; docs (if changed) build with `mkdocs --strict`.
- ‚úÖ Files live in correct directories and follow naming/indentation rules.
- ‚úÖ No plaintext secrets; examples use placeholders or SOPS-encrypted files.
- ‚úÖ Docs updated when behavior changes.
- ‚úÖ Conventional Commits for all messages.

---

## Work Style

- Prefer **small, focused PRs** per backlog item.
- Output **complete files** (not fragments) when modifying Go or YAML templates.
- Keep the CLI strictly **render-only**. Execution steps belong in comments/docs, not code.

---

## Your First Task (start now)

Implement **Backlog #1: CLI render pipeline**. Provide:

- Updated `cli/cmd/up.go` and any new packages (e.g., `cli/internal/render/...`).
- One provider overlay README update.
- A **dry-run sample**: show the file listing of `out/example-lab/` in your PR body.

---

## üì£ Final Note

InfraFlux aims for **automation, portability, and clarity**.
All code should be **self-explanatory** and **production-grade**, even in a homelab context.
